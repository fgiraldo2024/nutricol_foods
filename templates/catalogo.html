{% extends "base.html" %}

{% block title %}CatÃ¡logo de Productos - Nutricol Foods{% endblock %}

{% block content %}
  <div class="text-center my-5">

    <!-- Logo arriba, centrado -->
    <div class="text-center mb-4">
      <img src="{{ url_for('static', filename='img/logo_nutricol_transparent.png') }}" 
           alt="Logo Nutricol Foods" 
           style="max-width: 180px; height: auto; margin-bottom: 15px;">
      <h1 class="mb-0">CatÃ¡logo de Productos</h1>
    </div>

    <!-- Contenedor del catÃ¡logo -->
    <main class="container">
      <div id="catalogo" class="grid row g-4 justify-content-center"></div>
    </main>

    <!-- BotÃ³n global para enviar cotizaciÃ³n -->
    <div class="text-center mt-4">
      <button class="btn-vermas" onclick="irAContacto()">Ir a Contacto</button>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal">
    <span class="cerrar" onclick="cerrarModal()">&times;</span>
    <img class="modal-contenido" id="img-grande">
    <div id="info" class="info"></div>
  </div>

  <style>
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 18px;
    }
    .card {
      background:#fff; border-radius:14px;
      box-shadow:0 6px 14px rgba(0,0,0,.08);
      padding:14px; text-align:center;
      transition: transform .2s ease;
    }
    .card img { width:100%; height:200px; object-fit: contain; }
    .titulo { margin:10px 0 4px; font-weight:700; }

    .btn-vermas {
      margin-top: 10px;
      padding: 8px 14px;
      background: #2E8B57;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s ease;
    }
    .btn-vermas:hover {
      background: #256d46;
    }

    /* Modal estilos */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      padding-top: 60px;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.9);
    }
    .modal-contenido {
      margin: auto;
      display: block;
      max-width: 70%;
      max-height: 70%;
    }
    .cerrar {
      position: absolute;
      top: 15px;
      right: 35px;
      color: white;
      font-size: 40px;
      cursor: pointer;
    }
    .info {
      text-align: center;
      color: white;
      margin-top: 15px;
      font-size: 1.1rem;
    }
  </style>

<script>
  const jsonUrl = "{{ url_for('static', filename='data/catalogo.json') }}";
  const imgBase = "{{ url_for('static', filename='img/catalogo/') }}";

  let cotizacion = [];

  async function cargarCatalogo(){
    try {
      const resp = await fetch(jsonUrl, {cache:'no-store'});
      const productos = await resp.json();
      const grid = document.getElementById('catalogo');
      grid.innerHTML = '';

      productos.forEach(p => {
        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `
          <img src="${imgBase}${p.imagen}" loading="lazy" alt="${p.titulo}">
          <div class="titulo">${p.titulo}</div>
          <button class="btn-vermas" onclick='abrirModal(${JSON.stringify(p)})'>Ver mÃ¡s</button>
        `;
        grid.appendChild(el);
      });
    } catch (e){
      document.getElementById('catalogo').innerHTML = '<p>Error cargando el catÃ¡logo.</p>';
      console.error(e);
    }
  }

  function abrirModal(producto){
    document.getElementById("modal").style.display = "block";
    document.getElementById("img-grande").src = imgBase + producto.imagen;
    document.getElementById("info").innerHTML = `
      <div style="max-width:400px; margin:auto; text-align:center;">
        <h3 style="margin-bottom:8px;">${producto.titulo}</h3>
        <p style="margin-bottom:8px;">${producto.descripcion}</p>
        ${producto.presentacion ? `<p style="margin-bottom:8px;"><em>${producto.presentacion}</em></p>` : ""}
        <strong style="color:#2E8B57; font-size:1.2rem; display:block; margin-bottom:12px;">
          ${producto.precio}
        </strong>
        <button class="btn-vermas" style="margin-top:0;" onclick="agregarACotizacion('${producto.titulo}')">
          Cotizar
        </button>
      </div>
    `;
  }

  function cerrarModal(){
    document.getElementById("modal").style.display = "none";
  }

  function agregarACotizacion(titulo){
    if (!cotizacion.includes(titulo)){
      cotizacion.push(titulo);
      alert(`âœ… ${titulo} agregado a la cotizaciÃ³n`);
    }
  }

  function irAContacto(){
    if (cotizacion.length === 0){
      alert("No has agregado productos a la cotizaciÃ³n");
      return;
    }

    const url = "/contacto?productos=" + encodeURIComponent(cotizacion.join(", "));
    console.log("ðŸ‘‰ URL generada:", url);  // ðŸ‘ˆ aparece en la consola del navegador
    window.location.href = url;
  }

  cargarCatalogo();
</script>

{% endblock %}
